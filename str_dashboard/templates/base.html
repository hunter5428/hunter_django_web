{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>STR TF APP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root{
      --header-h: 60px;
      --sidebar-w: 240px;
      --bg-black: #000000;
      --bg-verydark: #121212;
      --text: #eaeaea;
      --text-dim: #bdbdbd;
      --accent: #4fc3f7;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin:0; color: var(--text); background: var(--bg-verydark); }
    a { color: inherit; text-decoration: none; }

    /* 헤더 */
    header.app-header {
      position: fixed; top:0; left:0; right:0; height: var(--header-h);
      background: var(--bg-black); display:flex; align-items:center; gap:12px;
      padding: 0 14px; z-index: 2000; border-bottom: 1px solid #1f1f1f;
    }
    .header-spacer { margin-left: auto; }
    .logout-btn, .logout-icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px;
      background: transparent;
      color:#bdbdbd;
      border:1px solid #2a2a2a;
      border-radius:8px;
      cursor:pointer;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
    }
    .logout-icon-btn:hover{ background:#141414; color:#eaeaea; border-color:#3a3a3a; }
    .logout-icon-btn:focus-visible{ outline:2px solid #2a2a2a; }

    /* 레이아웃 */
    .app-body { display: flex; width: 100%; padding-top: var(--header-h); }
    aside.app-sidebar {
      position: fixed; top: var(--header-h); left: 0; bottom: 0;
      width: var(--sidebar-w); background: var(--bg-black);
      border-right: 1px solid #1f1f1f;
      overflow-y: auto; transition: width .2s ease, transform .2s ease;
      will-change: width, transform; z-index: 1000;
    }
    main.app-main {
      margin-left: var(--sidebar-w);
      width: calc(100% - var(--sidebar-w));
      min-height: calc(100vh - var(--header-h));
      padding: 20px;
      transition: margin-left .2s ease, width .2s ease;
      background: var(--bg-verydark);
    }
    body.sidebar-collapsed aside.app-sidebar { transform: translateX(-100%); }
    body.sidebar-collapsed main.app-main { margin-left: 0; width: 100%; }

    /* 메뉴 */
    .menu-section { padding: 12px 10px; }
    .menu-top { font-weight: 700; color: var(--text); padding: 10px; border-radius: 8px; cursor: pointer; }
    .menu-top:hover { background: #111; }
    .menu-top.active { background: #111; outline: 1px solid #2a2a2a; }
    /* 디폴트 접힘 + 활성화 시 펼침 */
    .submenu { margin-top: 6px; padding-left: 8px; display:none; }
    .menu-top.active + .submenu { display:block; }

    .submenu a { display: block; padding: 8px 10px; margin: 4px 0; border-radius: 6px; color: var(--text-dim); }
    .submenu a:hover { background: #101010; color: var(--text); }
    .submenu a.active { background: #1a1a1a; color: var(--accent); font-weight: 700; }

    .app-title { font-size: 18px; font-weight: 800; letter-spacing: .3px; }

    .logo-btn {
      display:flex; align-items:center; gap:10px; cursor:pointer;
      background: transparent !important; border: 0 !important; padding: 0;
      border-radius: 0; box-shadow: none !important; -webkit-appearance: none; appearance: none;
    }
    .logo-btn:focus{ outline: none; }
    .logo-btn:focus-visible{ outline: 2px solid #2a2a2a; border-radius: 8px; }
    .logo-btn img{ height: 30px; width: 30px; display:block; background: transparent; }

    .card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 18px; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 8px; }
    ::-webkit-scrollbar-track { background: #0b0b0b; }
  </style>
</head>
<body class="{% if request.COOKIES.sidebar == 'collapsed' %}sidebar-collapsed{% endif %}">
  {% include "base_component/header.html" %}
  <div class="app-body">
    {% include "base_component/sidebar.html" %}
    <main class="app-main">
      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      /* ===== 경로/상태 ===== */
      const homeUrl = "{% url 'home' %}";
      const currentPath = window.location.pathname;
      const currentTop = "{{ active_top_menu|default:'' }}";   // '' on home
      const currentSub = "{{ active_sub_menu|default:'' }}";

      /* ===== 공통: 메모리 초기화 확인 (필요한 경우에만 호출) ===== */
      function confirmAndWipe() {
        const ok = window.confirm('이동하시겠습니까? 메모리 초기화됩니다.');
        if (!ok) return false;
        try { sessionStorage.clear(); localStorage.removeItem('app_temp'); } catch(e){}
        return true;
      }

      /* ===== 로고: 토글 + 360° 회전 ===== */
      const logoBtn = document.getElementById('logo-toggle');
      const logoImg = document.getElementById('logo-img');
      if (!document.getElementById('spin-style')) {
        const st = document.createElement('style');
        st.id = 'spin-style';
        st.textContent = `
          @keyframes spin360 { to { transform: rotate(360deg); } }
          #logo-img.spin { animation: spin360 .6s linear; }
        `;
        document.head.appendChild(st);
      }
      const toggleSidebar = () => {
        document.body.classList.toggle('sidebar-collapsed');
        document.cookie = "sidebar=" + (document.body.classList.contains('sidebar-collapsed') ? "collapsed" : "open") + ";path=/";
      };
      if (logoBtn) {
        logoBtn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          toggleSidebar();
          if (logoImg) {
            logoImg.classList.remove('spin'); void logoImg.offsetWidth; logoImg.classList.add('spin');
            logoImg.addEventListener('animationend', () => logoImg.classList.remove('spin'), { once:true });
          }
        });
      }

      /* ===== 헤더 제목: 홈 이동 (현재가 홈이면 확인창 X) ===== */
      const titleLink = document.getElementById('app-title-link');
      if (titleLink) {
        titleLink.addEventListener('click', function(e){
          if (currentPath === homeUrl) return;           // 이미 홈 → 묻지 않음
          if (!confirmAndWipe()) { e.preventDefault(); e.stopPropagation(); }
        });
      }

      /* ===== 상위 메뉴: menu1 =====
         규칙 변경: "홈 화면(현재 상위메뉴 없음) → 다른 상위메뉴" 이동 시에도 묻지 않음 & 초기화하지 않음.
         즉, currentTop === ''(홈) 또는 현재 상위메뉴와 동일할 때는 바로 이동.
      */
      const topMenu = document.querySelector('[data-topmenu="menu1"]');
      if (topMenu) {
        topMenu.addEventListener('click', function(){
          const firstSub = document.querySelector('[data-submenu="menu1_1"]');
          if (!firstSub) return;
          const targetHref = firstSub.getAttribute('href');

          if (currentTop === 'menu1' || currentTop === '') {
            // 같은 상위메뉴 내 이동 OR 홈→다른 상위메뉴: 확인/초기화 없이 바로 이동
            window.location.href = targetHref;
          } else {
            // 다른 상위메뉴 간 이동일 때만 확인 및 초기화
            if (confirmAndWipe()) window.location.href = targetHref;
          }
        });
      }

      /* ===== 로그아웃 (POST) ===== */
      const logoutForm = document.getElementById('logout-form');
      const logoutBtn  = document.getElementById('logout-btn');
      if (logoutForm && logoutBtn) {
        logoutBtn.addEventListener('click', function(e){
          const ok = window.confirm('로그아웃 하시겠습니까?');
          if (!ok) { e.preventDefault(); e.stopPropagation(); }
        });
      }

      /* ===== active 표시 & 펼침 ===== */
      if (currentTop){
        const elTop = document.querySelector(`[data-topmenu="${currentTop}"]`);
        if (elTop) elTop.classList.add('active');
      }
      if (currentSub){
        const elSub = document.querySelector(`[data-submenu="${currentSub}"]`);
        if (elSub) elSub.classList.add('active');
      }
    });
  </script>
</body>
</html>
